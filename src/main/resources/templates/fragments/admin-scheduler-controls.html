<!-- fragments/admin-scheduler-controls.html -->
<section xmlns:th="http://www.thymeleaf.org" th:fragment="adminSchedulerFragment">

    <h3>‚öôÔ∏è Email Polling Scheduler</h3>

    <div id="adminSchedulerControls" class="scheduler-container" style="margin-top:1rem; display:none;">
        <div class="scheduler-actions">
            <button id="startScheduler">‚ñ∂Ô∏è Start Polling</button>
            <button id="stopScheduler">‚èπÔ∏è Stop Polling</button>
            <span id="schedulerState" class="scheduler-status" style="margin-left:0.6rem;color:#555"></span>
        </div>
    </div>

    <style>
    .scheduler-container {
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .scheduler-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .scheduler-actions button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }

    .scheduler-actions button:hover {
      background: #1e40af;
    }

    .scheduler-status {
      font-weight: 500;
    }
  </style>

    <script>
  document.addEventListener('DOMContentLoaded', () => {
    if (!Auth.isAdmin()) return; // Only for admins

    const adminPanel = document.getElementById("panel-admin");
    const controls = document.getElementById("adminSchedulerControls");

    function initSchedulerControls() {
      if (!controls || controls.dataset.initialized) return;
      controls.dataset.initialized = true;
      controls.style.display = "block";

      async function updateState() {
        try {
          const r = await Auth.fetchWithAuth('/admin/scheduler/state');
          if (r.ok) {
            const s = await r.json();
            document.getElementById('schedulerState').innerText =
              s.enabled ? 'üü¢ Enabled' : 'üî¥ Disabled';
          }
        } catch (e) {
          console.error("Scheduler state fetch failed:", e);
        }
      }

      document.getElementById('startScheduler').addEventListener('click', async () => {
        const resp = await Auth.fetchWithAuth('/admin/scheduler/start', { method: 'POST' });
        alert(resp.ok ? '‚úÖ Scheduler started' : '‚ùå Failed to start');
        updateState();
      });

      document.getElementById('stopScheduler').addEventListener('click', async () => {
        const resp = await Auth.fetchWithAuth('/admin/scheduler/stop', { method: 'POST' });
        alert(resp.ok ? 'üõë Scheduler stopped' : '‚ùå Failed to stop');
        updateState();
      });

      updateState();
    }

    // Observe Admin tab activation
    const observer = new MutationObserver(() => {
      if (adminPanel.classList.contains("active")) {
        initSchedulerControls();
      }
    });
    observer.observe(adminPanel, { attributes: true, attributeFilter: ["class"] });
  });
  </script>

</section>